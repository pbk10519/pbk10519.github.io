import React, { useState, useEffect } from 'react';
import { Star, Trophy, Play, RotateCcw, Heart, Zap } from 'lucide-react';

const MLGame = () => {
  const [gameState, setGameState] = useState('intro');
  const [level, setLevel] = useState(1);
  const [score, setScore] = useState(0);
  const [stars, setStars] = useState(0);
  const [currentGift, setCurrentGift] = useState(null);
  const [feedback, setFeedback] = useState('');
  const [correctCount, setCorrectCount] = useState(0);
  const [totalCount, setTotalCount] = useState(0);
  const [timeLeft, setTimeLeft] = useState(60);
  const [accuracy, setAccuracy] = useState(100);
  const [trainingData, setTrainingData] = useState([]);

  // 선물 데이터: 무게(kg), 크기(cm), 색상밝기(0-100)
  const giftTypes = {
    toy: { 
      name: '🧸 장난감', 
      rules: (w, s, c) => w < 2 && s < 30,
      color: 'bg-pink-400',
      examples: [[0.5, 15, 80], [1.2, 25, 90], [0.8, 20, 85]]
    },
    book: { 
      name: '📚 책', 
      rules: (w, s, c) => w >= 2 && w < 4 && s < 40,
      color: 'bg-blue-400',
      examples: [[2.5, 30, 60], [3.2, 35, 55], [2.8, 32, 65]]
    },
    clothes: { 
      name: '👕 옷', 
      rules: (w, s, c) => w >= 1 && w < 3 && s >= 30 && s < 50,
      color: 'bg-green-400',
      examples: [[1.5, 40, 70], [2.2, 45, 75], [1.8, 42, 72]]
    },
    electronics: { 
      name: '🎮 전자기기', 
      rules: (w, s, c) => w >= 3 && s >= 40,
      color: 'bg-purple-400',
      examples: [[4.5, 50, 40], [5.2, 55, 45], [3.8, 48, 42]]
    }
  };

  const generateGift = () => {
    const types = Object.keys(giftTypes);
    const correctType = types[Math.floor(Math.random() * types.length)];
    const examples = giftTypes[correctType].examples;
    const example = examples[Math.floor(Math.random() * examples.length)];
    
    // 약간의 변동 추가
    const weight = Math.max(0.1, example[0] + (Math.random() - 0.5) * 0.5);
    const size = Math.max(5, example[1] + (Math.random() - 0.5) * 5);
    const brightness = Math.max(0, Math.min(100, example[2] + (Math.random() - 0.5) * 10));
    
    return {
      weight: parseFloat(weight.toFixed(1)),
      size: parseFloat(size.toFixed(0)),
      brightness: parseFloat(brightness.toFixed(0)),
      correctType
    };
  };

  useEffect(() => {
    if (gameState === 'playing' && timeLeft > 0) {
      const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
      return () => clearTimeout(timer);
    } else if (timeLeft === 0 && gameState === 'playing') {
      endGame();
    }
  }, [timeLeft, gameState]);

  useEffect(() => {
    if (gameState === 'playing' && !currentGift) {
      setCurrentGift(generateGift());
    }
  }, [gameState, currentGift]);

  const startGame = () => {
    setGameState('playing');
    setCurrentGift(generateGift());
    setCorrectCount(0);
    setTotalCount(0);
    setAccuracy(100);
    setTimeLeft(60);
    setFeedback('');
    setTrainingData([]);
  };

  const handleClassification = (selectedType) => {
    const isCorrect = selectedType === currentGift.correctType;
    const newTotal = totalCount + 1;
    const newCorrect = isCorrect ? correctCount + 1 : correctCount;
    
    setTotalCount(newTotal);
    setCorrectCount(newCorrect);
    setAccuracy(Math.round((newCorrect / newTotal) * 100));

    // 학습 데이터에 추가
    setTrainingData([...trainingData, {
      ...currentGift,
      predicted: selectedType,
      correct: isCorrect
    }]);

    if (isCorrect) {
      setScore(score + 100 + (level * 20));
      setFeedback('🎉 정답! AI가 학습했어요!');
      if (newCorrect % 5 === 0) {
        setStars(stars + 1);
      }
    } else {
      setFeedback(`❌ 틀렸어요! 정답은 ${giftTypes[currentGift.correctType].name}이에요!`);
    }

    setTimeout(() => {
      setCurrentGift(generateGift());
      setFeedback('');
    }, 1500);

    // 레벨업 조건
    if (newCorrect >= level * 10) {
      setLevel(level + 1);
      setTimeLeft(timeLeft + 20);
    }
  };

  const endGame = () => {
    setGameState('complete');
    const finalStars = Math.floor(accuracy / 20);
    setStars(stars + finalStars);
  };

  const resetGame = () => {
    setLevel(1);
    setScore(0);
    setStars(0);
    setGameState('intro');
    setTrainingData([]);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-red-50 via-green-50 to-blue-50 p-4" 
         style={{ fontFamily: "'Noto Sans KR', 'Spoqa Han Sans Neo', sans-serif" }}>
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet" />
      
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="text-center mb-6">
          <h1 className="text-5xl font-black text-red-600 mb-2 drop-shadow-lg">
            🎅 산타의 선물 분류 AI 🎁
          </h1>
          <p className="text-xl text-green-700 font-bold">머신러닝으로 선물을 분류해봐요!</p>
        </div>

        {/* Score Bar */}
        {gameState !== 'intro' && (
          <div className="bg-white rounded-3xl shadow-2xl p-4 mb-6 border-4 border-red-300">
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
              <div>
                <div className="text-sm text-gray-600 font-bold">점수</div>
                <div className="text-2xl font-black text-blue-600">{score}</div>
              </div>
              <div>
                <div className="text-sm text-gray-600 font-bold">별 ⭐</div>
                <div className="text-2xl font-black text-yellow-600">{stars}</div>
              </div>
              <div>
                <div className="text-sm text-gray-600 font-bold">레벨</div>
                <div className="text-2xl font-black text-purple-600">{level}</div>
              </div>
              <div>
                <div className="text-sm text-gray-600 font-bold">정확도</div>
                <div className={`text-2xl font-black ${accuracy >= 80 ? 'text-green-600' : 'text-orange-600'}`}>
                  {accuracy}%
                </div>
              </div>
              <div>
                <div className="text-sm text-gray-600 font-bold">남은 시간</div>
                <div className={`text-2xl font-black ${timeLeft <= 10 ? 'text-red-600 animate-pulse' : 'text-blue-600'}`}>
                  {timeLeft}초
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Intro Screen */}
        {gameState === 'intro' && (
          <div className="bg-white rounded-3xl shadow-2xl p-8 border-4 border-green-300">
            <div className="text-6xl text-center mb-6">🎅🎁🤖</div>
            <h2 className="text-3xl font-black text-red-600 mb-6 text-center">
              산타를 도와 선물을 분류하는 AI를 만들어요!
            </h2>
            
            <div className="bg-blue-50 rounded-2xl p-6 mb-6 border-3 border-blue-300">
              <h3 className="text-2xl font-black text-blue-700 mb-4">🎮 게임 방법</h3>
              <div className="space-y-3 text-lg">
                <div className="flex items-start gap-3">
                  <span className="text-2xl font-black">1️⃣</span>
                  <span className="font-bold">선물의 <span className="text-red-600">무게</span>, <span className="text-green-600">크기</span>, <span className="text-purple-600">색상</span>을 보고 어떤 종류인지 맞춰보세요!</span>
                </div>
                <div className="flex items-start gap-3">
                  <span className="text-2xl font-black">2️⃣</span>
                  <span className="font-bold">맞출수록 AI가 <span className="text-blue-600">학습</span>해서 더 똑똑해져요!</span>
                </div>
                <div className="flex items-start gap-3">
                  <span className="text-2xl font-black">3️⃣</span>
                  <span className="font-bold">정확도 80% 이상을 목표로 해요!</span>
                </div>
              </div>
            </div>

            <div className="bg-yellow-50 rounded-2xl p-6 mb-6 border-3 border-yellow-400">
              <h3 className="text-2xl font-black text-orange-700 mb-4">📦 선물 종류</h3>
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-pink-100 p-4 rounded-xl border-2 border-pink-300">
                  <div className="text-3xl mb-2">🧸</div>
                  <div className="font-black text-pink-700">장난감</div>
                  <div className="text-sm text-gray-600">가볍고 작아요</div>
                </div>
                <div className="bg-blue-100 p-4 rounded-xl border-2 border-blue-300">
                  <div className="text-3xl mb-2">📚</div>
                  <div className="font-black text-blue-700">책</div>
                  <div className="text-sm text-gray-600">중간 무게예요</div>
                </div>
                <div className="bg-green-100 p-4 rounded-xl border-2 border-green-300">
                  <div className="text-3xl mb-2">👕</div>
                  <div className="font-black text-green-700">옷</div>
                  <div className="text-sm text-gray-600">부피가 있어요</div>
                </div>
                <div className="bg-purple-100 p-4 rounded-xl border-2 border-purple-300">
                  <div className="text-3xl mb-2">🎮</div>
                  <div className="font-black text-purple-700">전자기기</div>
                  <div className="text-sm text-gray-600">무겁고 커요</div>
                </div>
              </div>
            </div>

            <div className="bg-green-50 rounded-2xl p-6 mb-6 border-3 border-green-300">
              <h3 className="text-2xl font-black text-green-700 mb-4">🧠 머신러닝이란?</h3>
              <p className="text-lg leading-relaxed">
                <span className="font-black text-blue-600">머신러닝</span>은 컴퓨터가 스스로 
                <span className="font-black text-purple-600"> 패턴</span>을 찾아 배우는 거예요! 
                여러분이 선물을 분류할 때마다 AI는 <span className="font-black text-red-600">"무게가 가벼우면 장난감"</span>, 
                <span className="font-black text-green-600"> "크고 무거우면 전자기기"</span> 같은 규칙을 
                <span className="font-black text-orange-600"> 학습</span>한답니다! 
                데이터가 많을수록 더 정확해져요! 🎯
              </p>
            </div>

            <button
              onClick={startGame}
              className="w-full bg-gradient-to-r from-red-500 to-green-500 text-white px-12 py-6 rounded-full text-3xl font-black hover:scale-105 transform transition shadow-xl flex items-center justify-center gap-3"
            >
              <Play size={40} />
              게임 시작하기!
            </button>
          </div>
        )}

        {/* Game Screen */}
        {gameState === 'playing' && currentGift && (
          <div className="space-y-6">
            {/* Current Gift */}
            <div className="bg-white rounded-3xl shadow-2xl p-8 border-4 border-purple-300">
              <h3 className="text-2xl font-black text-purple-600 mb-6 text-center">
                📦 이 선물은 무엇일까요?
              </h3>
              
              <div className="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl p-8 mb-6 border-4 border-yellow-400">
                <div className="text-center mb-8">
                  <div className="text-8xl mb-4">🎁</div>
                  <div className="text-xl font-bold text-gray-600">선물의 특징을 분석해보세요!</div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="bg-white p-6 rounded-2xl shadow-lg border-3 border-red-300">
                    <div className="text-4xl mb-3">⚖️</div>
                    <div className="text-sm text-gray-600 font-bold">무게 (Weight)</div>
                    <div className="text-4xl font-black text-red-600">{currentGift.weight}kg</div>
                  </div>
                  <div className="bg-white p-6 rounded-2xl shadow-lg border-3 border-green-300">
                    <div className="text-4xl mb-3">📏</div>
                    <div className="text-sm text-gray-600 font-bold">크기 (Size)</div>
                    <div className="text-4xl font-black text-green-600">{currentGift.size}cm</div>
                  </div>
                  <div className="bg-white p-6 rounded-2xl shadow-lg border-3 border-blue-300">
                    <div className="text-4xl mb-3">🎨</div>
                    <div className="text-sm text-gray-600 font-bold">밝기 (Brightness)</div>
                    <div className="text-4xl font-black text-blue-600">{currentGift.brightness}%</div>
                  </div>
                </div>
              </div>

              {/* Classification Buttons */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {Object.entries(giftTypes).map(([type, data]) => (
                  <button
                    key={type}
                    onClick={() => handleClassification(type)}
                    className={`${data.color} text-white p-6 rounded-2xl font-black text-xl hover:scale-105 transform transition shadow-lg border-4 border-white hover:border-yellow-400`}
                  >
                    <div className="text-4xl mb-2">{data.name.split(' ')[0]}</div>
                    <div>{data.name.split(' ')[1]}</div>
                  </button>
                ))}
              </div>

              {/* Feedback */}
              {feedback && (
                <div className={`mt-6 p-6 rounded-2xl text-center text-2xl font-black ${
                  feedback.includes('정답') ? 'bg-green-100 text-green-700 border-4 border-green-400' : 'bg-red-100 text-red-700 border-4 border-red-400'
                }`}>
                  {feedback}
                </div>
              )}
            </div>

            {/* Training Progress */}
            <div className="bg-white rounded-3xl shadow-2xl p-6 border-4 border-blue-300">
              <h3 className="text-xl font-black text-blue-600 mb-4">🤖 AI 학습 현황</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded-xl text-center border-2 border-blue-200">
                  <div className="text-sm text-gray-600 font-bold">학습한 데이터</div>
                  <div className="text-3xl font-black text-blue-600">{totalCount}개</div>
                </div>
                <div className="bg-green-50 p-4 rounded-xl text-center border-2 border-green-200">
                  <div className="text-sm text-gray-600 font-bold">정답 개수</div>
                  <div className="text-3xl font-black text-green-600">{correctCount}개</div>
                </div>
                <div className="bg-red-50 p-4 rounded-xl text-center border-2 border-red-200">
                  <div className="text-sm text-gray-600 font-bold">오답 개수</div>
                  <div className="text-3xl font-black text-red-600">{totalCount - correctCount}개</div>
                </div>
                <div className="bg-purple-50 p-4 rounded-xl text-center border-2 border-purple-200">
                  <div className="text-sm text-gray-600 font-bold">레벨업까지</div>
                  <div className="text-3xl font-black text-purple-600">{Math.max(0, level * 10 - correctCount)}개</div>
                </div>
              </div>
              
              {/* Accuracy Bar */}
              <div className="mt-4">
                <div className="flex justify-between items-center mb-2">
                  <span className="font-bold text-gray-600">정확도</span>
                  <span className="font-black text-2xl">{accuracy}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden border-2 border-gray-300">
                  <div 
                    className={`h-full rounded-full transition-all duration-500 ${
                      accuracy >= 80 ? 'bg-green-500' : accuracy >= 60 ? 'bg-yellow-500' : 'bg-red-500'
                    }`}
                    style={{ width: `${accuracy}%` }}
                  />
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Complete Screen */}
        {gameState === 'complete' && (
          <div className="bg-white rounded-3xl shadow-2xl p-8 border-4 border-yellow-300">
            <div className="text-8xl text-center mb-4">
              {accuracy >= 80 ? '🎉🏆🎊' : '💪📚🔥'}
            </div>
            <h2 className="text-4xl font-black text-center mb-6" style={{
              color: accuracy >= 80 ? '#16a34a' : '#ea580c'
            }}>
              {accuracy >= 80 ? '대단해요! AI 전문가!' : '좋아요! 더 연습해봐요!'}
            </h2>
            
            <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-8 mb-6 border-4 border-purple-300">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-6 text-center mb-6">
                <div>
                  <div className="text-sm text-gray-600 font-bold">총 점수</div>
                  <div className="text-4xl font-black text-blue-600">{score}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600 font-bold">획득 별</div>
                  <div className="text-4xl font-black text-yellow-600">{stars}⭐</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600 font-bold">최종 레벨</div>
                  <div className="text-4xl font-black text-purple-600">{level}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600 font-bold">최종 정확도</div>
                  <div className="text-4xl font-black text-green-600">{accuracy}%</div>
                </div>
              </div>
              
              <div className="text-center">
                <div className="text-2xl font-black text-gray-700 mb-2">학습 결과</div>
                <div className="text-lg font-bold">
                  총 <span className="text-blue-600">{totalCount}개</span>의 선물로 AI를 훈련시켰어요!
                </div>
                <div className="text-lg font-bold">
                  <span className="text-green-600">{correctCount}개 정답</span>, 
                  <span className="text-red-600"> {totalCount - correctCount}개 오답</span>
                </div>
              </div>
            </div>

            <div className="bg-blue-50 rounded-2xl p-6 mb-6 border-3 border-blue-300">
              <h3 className="text-2xl font-black text-blue-700 mb-4">🎓 배운 것</h3>
              <div className="space-y-3 text-lg font-bold">
                <div className="flex items-start gap-3">
                  <span>✅</span>
                  <span><span className="text-purple-600">특징(Feature)</span>을 보고 분류하는 법</span>
                </div>
                <div className="flex items-start gap-3">
                  <span>✅</span>
                  <span><span className="text-green-600">학습 데이터</span>가 많을수록 정확해진다는 것</span>
                </div>
                <div className="flex items-start gap-3">
                  <span>✅</span>
                  <span><span className="text-red-600">정확도(Accuracy)</span>로 AI 성능을 측정하는 법</span>
                </div>
                <div className="flex items-start gap-3">
                  <span>✅</span>
                  <span><span className="text-blue-600">분류(Classification)</span> 머신러닝의 원리!</span>
                </div>
              </div>
            </div>

            <button
              onClick={resetGame}
              className="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white px-10 py-6 rounded-full text-2xl font-black hover:scale-105 transform transition shadow-xl flex items-center justify-center gap-3"
            >
              <RotateCcw size={32} />
              다시 도전하기!
            </button>
          </div>
        )}

        {/* Footer */}
        <div className="text-center mt-8 text-gray-600">
          <p className="text-base font-bold">🎄 즐거운 머신러닝 학습 되세요! ⛄</p>
        </div>
      </div>
    </div>
  );
};

export default MLGame;
